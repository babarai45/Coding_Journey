flowchart TD
    A[ðŸš€ Rust Source Code] --> B[ðŸ“ Lexical Analysis]
B --> C[ðŸ” Token Stream Creation]
C --> D{ðŸŽ¯ Macro Found?}
D -->|âŒ No| E[ðŸ“‹ Continue Normal Parsing]
D -->|âœ… Yes| F[ðŸŽª Macro Invocation Detected]

F --> G[ðŸ”Ž Pattern Matching Phase]
G --> H{ðŸ§© Pattern Matches?}
H -->|âŒ No Match| I[ðŸ’¥ Compile Error]
H -->|âœ… Match Found| J[âš¡ Macro Expansion]

J --> K[ðŸ—ï¸ Generate New Code]
K --> L[ðŸ”„ Replace Macro Call]
L --> M{ðŸ” More Macros?}
M -->|âœ… Yes| F
M -->|âŒ No| N[ðŸ“Š Parse Generated Code]

N --> O[ðŸ”§ Type Checking]
O --> P[ðŸŽ¯ Code Generation]
P --> Q[ðŸ’¾ Final Binary]

E --> O

%% Detailed macro expansion subprocess
subgraph MACRO_EXPAND [ðŸŽª Macro Expansion Details]
direction TB
MA[ðŸ“¥ Input: println!("Hello, {}!", name)]
MB[ðŸ” Parse Pattern: ($($arg:tt)*)]
MC[âš™ï¸ Match Tokens]
MD[ðŸ—ï¸ Generate: std::io::_print(...)]
ME[ðŸ“¤ Output: Expanded Code]

MA --> MB --> MC --> MD --> ME
end

%% Pattern matching details
subgraph PATTERN [ðŸ§© Pattern Matching Engine]
direction TB
PA[ðŸŽ¯ macro_rules! Definition]
PB[ðŸ“‹ Input Token Stream]
PC[ðŸ”„ Try Each Pattern]
PD{âœ… Match Found?}
PE[âš¡ Execute Template]
PF[ðŸš« Try Next Pattern]

PA --> PC
PB --> PC
PC --> PD
PD -->|âœ… Yes| PE
PD -->|âŒ No| PF
PF --> PC
end

%% Token types
subgraph TOKENS [ðŸŽ² Token Types]
direction LR
T1[ðŸ·ï¸ ident: variable names]
T2[ðŸ“Š expr: expressions]
T3[ðŸ”§ ty: types]
T4[ðŸ“ stmt: statements]
T5[ðŸ§± block: code blocks]
T6[ðŸ’Ž literal: values]
end

%% Repetition handling
subgraph REP [ðŸ” Repetition Handling]
direction TB
R1[ðŸ“¥ Input: $($item:expr),*]
R2[ðŸ”„ Split by Separator]
R3[âš¡ Expand Each Item]
R4[ðŸ”— Join Results]
R5[ðŸ“¤ Output: Combined Code]

R1 --> R2 --> R3 --> R4 --> R5
end

%% Styling
classDef source fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
classDef decision fill:#fff8e1,stroke:#f57f17,stroke-width:2px,color:#000
classDef macro fill:#e8f5e8,stroke:#1b5e20,stroke-width:3px,color:#000
classDef error fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
classDef output fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000

class A,B,C source
class E,G,J,K,L,N,O,P process
class D,H,M decision
class F,Q macro
class I error
class Q output

style MACRO_EXPAND fill:#f0f4c3,stroke:#827717,stroke-width:2px
style PATTERN fill:#e0f2f1,stroke:#00695c,stroke-width:2px
style TOKENS fill:#fce4ec,stroke:#880e4f,stroke-width:2px
style REP fill:#e8eaf6,stroke:#283593,stroke-width:2px